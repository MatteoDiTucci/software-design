<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tests for distributed systems - A Compendium of Software Design</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A summary with sources of what contributes to good software design">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/introduction.html"><strong aria-hidden="true">2.</strong> It passes all tests</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../passes-all-tests/test-pyramid.html"><strong aria-hidden="true">2.1.</strong> Test pyramid</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/if-testing-is-hard-inject.html"><strong aria-hidden="true">2.2.</strong> If testing is hard, inject what you need to verify</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-doubles.html"><strong aria-hidden="true">2.3.</strong> Test doubles</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-driven-development.html"><strong aria-hidden="true">2.4.</strong> Test driven development</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-coverage-is-not-enough.html"><strong aria-hidden="true">2.5.</strong> Test coverage is not enough</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/tests-must-be-reproducible.html"><strong aria-hidden="true">2.6.</strong> Tests must be reproducible</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/no-production-code-constants-in-tests.html"><strong aria-hidden="true">2.7.</strong> No production code constants in tests</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/do-not-test-external-libraries.html"><strong aria-hidden="true">2.8.</strong> Do not test external libraries 🏗️</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/expand-and-contract.html"><strong aria-hidden="true">2.9.</strong> Expand and contract 🏗️</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/performance-tests.html"><strong aria-hidden="true">2.10.</strong> Performance tests 🏗️</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/how-to-test-ui.html"><strong aria-hidden="true">2.11.</strong> How to test UI 🏗️</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/linting.html"><strong aria-hidden="true">2.12.</strong> Linting 🏗️</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-for-production.html"><strong aria-hidden="true">2.13.</strong> Test for production</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/tests-for-distributed-systems.html" class="active"><strong aria-hidden="true">2.14.</strong> Tests for distributed systems</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-infrastructure.html"><strong aria-hidden="true">2.15.</strong> Test infrastructure 🏗️</a></li></ol></li><li class="chapter-item expanded "><a href="../expresses-intent/introduction.html"><strong aria-hidden="true">3.</strong> It expresses intent</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../expresses-intent/naming.html"><strong aria-hidden="true">3.1.</strong> Naming</a></li><li class="chapter-item expanded "><a href="../expresses-intent/deep-and-narrow-classes.html"><strong aria-hidden="true">3.2.</strong> Deep and narrow classes</a></li><li class="chapter-item expanded "><a href="../expresses-intent/immutability.html"><strong aria-hidden="true">3.3.</strong> Immutability</a></li><li class="chapter-item expanded "><a href="../expresses-intent/generalise-edge-cases.html"><strong aria-hidden="true">3.4.</strong> Generalise edge cases️</a></li><li class="chapter-item expanded "><a href="../expresses-intent/small-classes-and-short-methods.html"><strong aria-hidden="true">3.5.</strong> Small classes and short methods 🏗️</a></li><li class="chapter-item expanded "><a href="../expresses-intent/usually-composition-is-better-than-inheritance.html"><strong aria-hidden="true">3.6.</strong> Usually composition is better than inheritance 🏗️</a></li><li class="chapter-item expanded "><a href="../expresses-intent/test-naming.html"><strong aria-hidden="true">3.7.</strong> Test naming 🏗️</a></li><li class="chapter-item expanded "><a href="../expresses-intent/comment-the-why.html"><strong aria-hidden="true">3.8.</strong> Comment the why 🏗️</a></li><li class="chapter-item expanded "><a href="../expresses-intent/visual-indentation.html"><strong aria-hidden="true">3.9.</strong> Visual indentation 🏗️</a></li><li class="chapter-item expanded "><a href="../expresses-intent/folder-structure.html"><strong aria-hidden="true">3.10.</strong> Folder structure 🏗️</a></li><li class="chapter-item expanded "><a href="../expresses-intent/wishful-thinking.html"><strong aria-hidden="true">3.11.</strong> Wishful thinking 🏗️</a></li></ol></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/introduction.html"><strong aria-hidden="true">4.</strong> It does not repeat itself</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../does-not-repeat-itself/one-single-authoritative-representation.html"><strong aria-hidden="true">4.1.</strong> One single authoritative knowledge representation</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/do-not-abstract-by-visual-pattern-matching.html"><strong aria-hidden="true">4.2.</strong> Do not abstract by visual pattern matching</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/open-closed-principle.html"><strong aria-hidden="true">4.3.</strong> Open-closed principle️</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/dependency-inversion-principle.html"><strong aria-hidden="true">4.4.</strong> Dependency inversion principle</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/information-hiding.html"><strong aria-hidden="true">4.5.</strong> Information hiding️</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/wrap-external-libraries-into-custom-classes.html"><strong aria-hidden="true">4.6.</strong> Wrap external libraries into custom classes️</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/polymorphism.html"><strong aria-hidden="true">4.7.</strong> Polymorphism 🏗️</a></li><li class="chapter-item expanded "><a href="../expresses-intent/single-responsibility-principle.html"><strong aria-hidden="true">4.8.</strong> Single responsibility principle 🏗️</a></li></ol></li><li class="chapter-item expanded "><a href="../does-not-contain-superfluous-parts/introduction.html"><strong aria-hidden="true">5.</strong> It does not contain superfluous parts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../does-not-contain-superfluous-parts/you-are-not-going-to-need-it.html"><strong aria-hidden="true">5.1.</strong> Does not contain superfluous parts</a></li><li class="chapter-item expanded "><a href="../does-not-contain-superfluous-parts/clarify-what-is-superfluous.html"><strong aria-hidden="true">5.2.</strong> Clarify what is superfluous</a></li><li class="chapter-item expanded "><a href="../does-not-contain-superfluous-parts/do-not-abuse-design-patterns.html"><strong aria-hidden="true">5.3.</strong> Do not abuse design patterns</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">A Compendium of Software Design</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2><a class="header" href="#tests-for-distributed-systems" id="tests-for-distributed-systems">Tests for distributed systems</a></h2>
<p>When testing a functionality that spans across multiple microservices, there are some tradeoffs to make between tests maintainability and coverage.
As an example, let's take a Price microservice which needs to contact three other microservices to be able to calculate a price.
We are responsible for the Price microservice only, while other teams take care of Membership, Discount and Inventory microservices respectively.<br />
<img src="images/distributed-systems-example.png" alt="distributed-systems-example.png" /></p>
<p>Let's assume we want to write an acceptance test to verify the functionality of calculating a price.
For this purpose, we need also the other three microservices to be up running while the acceptance test runs.
Usually there are four ways to achieve this. Each one has pros and cons, but in my experience, the first has proved to be superior.<br />
In all four alternatives, when we say locally, we mean both the developers laptops and the <a href="https://martinfowler.com/articles/continuousIntegration.html">continuous integration</a> machine.</p>
<h3><a class="header" href="#stub-the-three-microservices-integration-locally-and-use-in-depth-smoke-tests" id="stub-the-three-microservices-integration-locally-and-use-in-depth-smoke-tests">Stub the three microservices integration locally and use in depth smoke tests</a></h3>
<p>The acceptance test is converted into a functional test that runs locally and a smoke test that runs against the different environments (e.g. development and production).
Regarding the functional test, the Price service is started by stubbing the integration with the other three microservices.
This means that despite the integration with the three microservices might happen over https, when the functional test runs, there is no network or other infrastructure involved.</p>
<p>Regarding the smoke test, it triggers the real integration between the four microservices, as a production shopper request would do.</p>
<p>Pros:</p>
<ul>
<li>The smoke test verifies the real logic for both 4 microservices</li>
<li>No extra infrastructure needed locally</li>
<li>No powerful hardware needed locally</li>
<li>Chance of writing many functional tests in exchange for the acceptance test as the former is faster to run, write and maintain than the latter</li>
<li>No need to worry about authentication at functional test level</li>
</ul>
<p>Cons:</p>
<ul>
<li>Integration bugs between microservices cannot be caught locally: they will be visible during the smoke test execution.<br />
This late feedback loop around integration can be fixed by using contract testing (see resources section below)</li>
<li>Difficult to stub the three microservices integration if infrastructure is mixed with domain inside the Price service codebase</li>
</ul>
<h3><a class="header" href="#integrate-with-the-other-three-microservices-deployed-in-dev-environment" id="integrate-with-the-other-three-microservices-deployed-in-dev-environment">Integrate with the other three microservices deployed in dev environment</a></h3>
<p>This implies that the acceptance test reaches out to the dev environment where Inventory, Discount and Membership microservices are deployed.</p>
<p>Pros:</p>
<ul>
<li>The acceptance test verifies the real logic for both 4 microservices, nothing is stubbed</li>
<li>No extra infrastructure needed locally</li>
<li>No powerful hardware needed</li>
</ul>
<p>Cons</p>
<ul>
<li>Network connectivity is needed</li>
<li>Extra network configuration (e.g. VPN, firewall rules)</li>
<li>Risk of race conditions on test data related to the three microservices as multiple devs and continuous integration machine might run tests simultaneously</li>
<li>Extra work possibly needed for authentication</li>
</ul>
<h3><a class="header" href="#run-the-other-three-microservices-locally" id="run-the-other-three-microservices-locally">Run the other three microservices locally</a></h3>
<p>This implies fetching the executables of the other three microservices (e.g. Docker images, jar, etc.) and running them locally while the acceptance test is executed.</p>
<p>Pros:</p>
<ul>
<li>The acceptance test verifies the real logic for both 4 microservices, nothing is stubbed</li>
</ul>
<p>Cons:</p>
<ul>
<li>Acceptance test is slow as all fours microservices have to startup first</li>
<li>More powerful hardware is needed (usually ram and cpu) locally</li>
<li>Extra infrastructure is needed to make available the Inventory, Discount and Membership microservices executables (e.g. VPN, access policies configuration, firewall rules, etc.)</li>
<li>Extra setup is needed locally to run the acceptance tests (e.g. install Docker)</li>
<li>Extra work possibly needed for user authentication</li>
</ul>
<h3><a class="header" href="#stub-the-three-microservices-locally" id="stub-the-three-microservices-locally">Stub the three microservices locally</a></h3>
<p>This implies using libraries like <a href="https://wiremock.org/docs/getting-started/">WireMock server</a> to stub the responses from the other three microservices.</p>
<p>Pros:</p>
<ul>
<li>No network connectivity needed</li>
</ul>
<p>Cons:</p>
<ul>
<li>Slower acceptance test as 3 microservices stubs need to startup</li>
<li>External library as extra test dependency</li>
<li>If any api contract change happens in the other three microservices, the acceptance test won't fail</li>
<li>Requires effective and timely communication between the four microservices teams to notify and adjust any api contract change</li>
</ul>
<br/>  
<h4><a class="header" href="#recommended-reads" id="recommended-reads">Recommended reads</a></h4>
<ul>
<li><a href="https://martinfowler.com/articles/microservice-testing/">Testing strategies in a microservice architecture - Toby Clemson</a></li>
<li><a href="https://martinfowler.com/articles/practical-test-pyramid.html#ContractTests">Contract testing - Ham Vocke</a></li>
<li><a href="https://martinfowler.com/articles/qa-in-production.html">QA in production - Rouan Wilsenach</a></li>
<li><a href="https://martinfowler.com/bliki/SyntheticMonitoring.html">Synthetic Monitoring - Flávia Falé, Serge Gebhardt</a></li>
</ul>
<h4><a class="header" href="#teach-me-back" id="teach-me-back">Teach me back</a></h4>
<p>I really appreciate any <a href="../introduction/introduction.html#teach-me-back">feedback</a> about the book and my current understanding of software design.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../passes-all-tests/test-for-production.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../passes-all-tests/test-infrastructure.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../passes-all-tests/test-for-production.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../passes-all-tests/test-infrastructure.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>

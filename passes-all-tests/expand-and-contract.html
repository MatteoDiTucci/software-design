<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Expand and contract - A Compendium of Software Design</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A summary with sources of what contributes to good software design">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/introduction.html"><strong aria-hidden="true">2.</strong> It passes all tests</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../passes-all-tests/test-pyramid.html"><strong aria-hidden="true">2.1.</strong> Test pyramid</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/if-testing-is-hard-inject.html"><strong aria-hidden="true">2.2.</strong> If testing is hard, inject what you need to verify</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-doubles.html"><strong aria-hidden="true">2.3.</strong> Test doubles</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-driven-development.html"><strong aria-hidden="true">2.4.</strong> Test driven development</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-coverage-is-not-enough.html"><strong aria-hidden="true">2.5.</strong> Test coverage is not enough</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/tests-must-be-reproducible.html"><strong aria-hidden="true">2.6.</strong> Tests must be reproducible</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/no-production-code-constants-in-tests.html"><strong aria-hidden="true">2.7.</strong> No production code constants in tests</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/expand-and-contract.html" class="active"><strong aria-hidden="true">2.8.</strong> Expand and contract</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-for-production.html"><strong aria-hidden="true">2.9.</strong> Test for production</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/tests-for-distributed-systems.html"><strong aria-hidden="true">2.10.</strong> Tests for distributed systems</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/performance-tests.html"><strong aria-hidden="true">2.11.</strong> Performance tests</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/do-not-test-external-libraries.html"><strong aria-hidden="true">2.12.</strong> Do not test external libraries üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/how-to-test-ui.html"><strong aria-hidden="true">2.13.</strong> How to test UI üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/linting.html"><strong aria-hidden="true">2.14.</strong> Linting üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../passes-all-tests/test-infrastructure.html"><strong aria-hidden="true">2.15.</strong> Test infrastructure üèóÔ∏è</a></li></ol></li><li class="chapter-item expanded "><a href="../expresses-intent/introduction.html"><strong aria-hidden="true">3.</strong> It expresses intent</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../expresses-intent/naming.html"><strong aria-hidden="true">3.1.</strong> Naming</a></li><li class="chapter-item expanded "><a href="../expresses-intent/deep-and-narrow-classes.html"><strong aria-hidden="true">3.2.</strong> Deep and narrow classes</a></li><li class="chapter-item expanded "><a href="../expresses-intent/immutability.html"><strong aria-hidden="true">3.3.</strong> Immutability</a></li><li class="chapter-item expanded "><a href="../expresses-intent/generalise-edge-cases.html"><strong aria-hidden="true">3.4.</strong> Generalise edge casesÔ∏è</a></li><li class="chapter-item expanded "><a href="../expresses-intent/usually-composition-is-better-than-inheritance.html"><strong aria-hidden="true">3.5.</strong> Usually composition is better than inheritance</a></li><li class="chapter-item expanded "><a href="../expresses-intent/small-classes-and-short-methods.html"><strong aria-hidden="true">3.6.</strong> Small classes and short methods üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../expresses-intent/homogeneity.html"><strong aria-hidden="true">3.7.</strong> Homogeneity üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../expresses-intent/test-naming.html"><strong aria-hidden="true">3.8.</strong> Test naming üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../expresses-intent/comment-the-why.html"><strong aria-hidden="true">3.9.</strong> Comment the why üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../expresses-intent/visual-indentation.html"><strong aria-hidden="true">3.10.</strong> Visual indentation üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../expresses-intent/folder-structure.html"><strong aria-hidden="true">3.11.</strong> Folder structure üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../expresses-intent/wishful-thinking.html"><strong aria-hidden="true">3.12.</strong> Wishful thinking üèóÔ∏è</a></li></ol></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/introduction.html"><strong aria-hidden="true">4.</strong> It does not repeat itself</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../does-not-repeat-itself/one-single-authoritative-representation.html"><strong aria-hidden="true">4.1.</strong> One single authoritative knowledge representation</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/do-not-abstract-by-visual-pattern-matching.html"><strong aria-hidden="true">4.2.</strong> Do not abstract by visual pattern matching</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/open-closed-principle.html"><strong aria-hidden="true">4.3.</strong> Open-closed principleÔ∏è</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/dependency-inversion-principle.html"><strong aria-hidden="true">4.4.</strong> Dependency inversion principle</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/information-hiding.html"><strong aria-hidden="true">4.5.</strong> Information hidingÔ∏è</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/wrap-external-libraries-into-custom-classes.html"><strong aria-hidden="true">4.6.</strong> Wrap external libraries into custom classesÔ∏è</a></li><li class="chapter-item expanded "><a href="../does-not-repeat-itself/polymorphism.html"><strong aria-hidden="true">4.7.</strong> Polymorphism üèóÔ∏è</a></li><li class="chapter-item expanded "><a href="../expresses-intent/single-responsibility-principle.html"><strong aria-hidden="true">4.8.</strong> Single responsibility principle üèóÔ∏è</a></li></ol></li><li class="chapter-item expanded "><a href="../does-not-contain-superfluous-parts/introduction.html"><strong aria-hidden="true">5.</strong> It does not contain superfluous parts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../does-not-contain-superfluous-parts/you-are-not-going-to-need-it.html"><strong aria-hidden="true">5.1.</strong> Does not contain superfluous parts</a></li><li class="chapter-item expanded "><a href="../does-not-contain-superfluous-parts/clarify-what-is-superfluous.html"><strong aria-hidden="true">5.2.</strong> Clarify what is superfluous</a></li><li class="chapter-item expanded "><a href="../does-not-contain-superfluous-parts/do-not-abuse-design-patterns.html"><strong aria-hidden="true">5.3.</strong> Do not abuse design patterns</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">A Compendium of Software Design</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2><a class="header" href="#expand-and-contract" id="expand-and-contract">Expand and contract</a></h2>
<p>When we change the signature of a public method, we need to adjust all its client code accordingly. 
In big codebases this implies a single, time-consuming refactoring which can lead to version control conflicts (e.g. git merge conflicts)
with other developers. However, we can break down this big refactoring into smaller steps by leveraging a technique called expand and contract.
Let's take the following code as an example:</p>
<pre><code class="language-kotlin">import java.math.BigDecimal

class Price(private val amount: BigDecimal) {

    fun discountedOf(percentage: BigDecimal): Price { 
        val discount = amount.multiply(percentage.divide(BigDecimal(100)))
        return Price(amount.subtract(discount))
    }
}
</code></pre>
<p>The <code>percentage</code> input parameter of the method <code>discountedOf</code> can be problematic as there is no guarantee for it to be between 0 and 100.
For this reason, we want to introduce a class <code>Percentage</code> so that the signature of the method <code>discountedOf</code> can become <code>discountedOf(percentage: Percentage)</code>.
Let's see how we can do this in small steps with the expand and contract technique.</p>
<h3><a class="header" href="#1-expand" id="1-expand">1. Expand</a></h3>
<p>Instead of modifying the signature of the method <code>discountedOf</code> right away, we add a new method <code>newDiscountedOf</code> which has the desired new signature:</p>
<pre><code class="language-kotlin">import java.math.BigDecimal

class Price(private val amount: BigDecimal) {

    fun newDiscountedOf(percentage: Percentage): Price {
        val discount = percentage.of(amount)
        return Price(amount.subtract(discount))
    }

    fun discountedOf(percentage: BigDecimal): Price {
        val discount = amount.multiply(percentage.divide(BigDecimal(100)))
        return Price(amount.subtract(discount))
    }
}

class Percentage(private val percentage: BigDecimal) {
    init {
        require(percentage in BigDecimal(0)..BigDecimal(100) ) {
            &quot;Percentage must be between 0 and 100&quot;
        }
    }

    fun of(amount: BigDecimal): BigDecimal {
        return amount.multiply(percentage.divide(BigDecimal(100)))
    }
}
</code></pre>
<p>At this point for the client code nothing has changed: everybody still use the method <code>discountedOf</code> while <code>newDiscountedOf</code>
is dead code.</p>
<h3><a class="header" href="#2-migrate-clients-one-by-one" id="2-migrate-clients-one-by-one">2. Migrate clients one by one</a></h3>
<p>Now we can migrate the client code. However, instead of doing it all at once, we can refactor one client at a time.
In this way we can gradually increase the usage of <code>newDiscountedOf</code> while reducing the one of <code>discountedOf</code>.
Each client migration can be a standalone code revision (git commit), so the changes are small and incremental while 
the entire codebase keeps working as expected.</p>
<h3><a class="header" href="#3-contract" id="3-contract">3. Contract</a></h3>
<p>When all clients have been migrated, the method <code>discountedOf</code> is now dead code, so we can delete it and rename the method
<code>newDiscountedOf</code> into <code>discountedOf</code>. The final result looks like the following:</p>
<pre><code class="language-kotlin">import java.math.BigDecimal

class Price(private val amount: BigDecimal) {

    fun discountedOf(percentage: Percentage): Price {
        val discount = percentage.of(amount)
        return Price(amount.subtract(discount))
    }
}

class Percentage(private val percentage: BigDecimal) {
    init {
        require(percentage in BigDecimal(0)..BigDecimal(100) ) {
            &quot;Percentage must be between 0 and 100&quot;
        }
    }

    fun of(amount: BigDecimal): BigDecimal {
        return amount.multiply(percentage.divide(BigDecimal(100)))
    }
}
</code></pre>
<p>The end result is the same as we would have done it in one shot. However, we made the refactoring more maneageable by
breaking it down into smaller steps.</p>
<h3><a class="header" href="#further-applications" id="further-applications">Further applications</a></h3>
<p>Expand and contract is very useful to avoid merge conflicts, no matter if you are using <a href="https://martinfowler.com/articles/branching-patterns.html">trunk base development or feature branches</a>.
Especially with trunk based development, it plays very well with the use of <a href="https://martinfowler.com/articles/feature-toggles.html">feature toggles</a>.</p>
<p>Furthermore, despite the above example is about a class method, the same approach is applicable to api contracts.
Let's assume for instance a POST REST API with the following body:</p>
<pre><code class="language-json">{
  &quot;price&quot; : 72.9,
  &quot;discount&quot; : 15
}
</code></pre>
<p>Then, let's assume we want to change <code>&quot;discount&quot;</code> from an integer to a percentage expressed as a decimal between 0 and 1.
Using the expand and contract approach, we would first expand:</p>
<pre><code class="language-json">{
  &quot;price&quot; : 72.9,
  &quot;discount&quot; : 15,
  &quot;discount_percentage&quot; : 0.15
}
</code></pre>
<p>Then migrate all clients to use <code>&quot;discount_percentage&quot;</code> instead of <code>&quot;discount&quot;</code> and finally contract:</p>
<pre><code class="language-json">{
  &quot;price&quot; : 72.9,
  &quot;discount_percentage&quot; : 0.15
}
</code></pre>
<p>Last but not least, we can use expand and contract also for database schema migrations.</p>
<br/>  
<h4><a class="header" href="#recommended-reads" id="recommended-reads">Recommended reads</a></h4>
<ul>
<li><a href="https://oooops.dev/2021/07/30/surviving-continuous-deployment-in-distributed-systems/">Surviving continuous deployment in distributed systems - Valentina Servile</a></li>
<li><a href="https://www.goodreads.com/book/show/161302.Refactoring_Databases">Refactoring Databases: Evolutionary Database Design - Scott Ambler, Pramod Sadalage</a></li>
<li><a href="https://www.infoq.com/presentations/The-Limited-Red-Society/">Parallel change - Scott Ambler, Joshua Kerievsky</a></li>
<li><a href="https://martinfowler.com/bliki/ParallelChange.html">Parallel change - Danilo Sato</a></li>
</ul>
<h4><a class="header" href="#teach-me-back" id="teach-me-back">Teach me back</a></h4>
<p>I really appreciate any <a href="../introduction/introduction.html#teach-me-back">feedback</a> about the book and my current understanding of software design.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../passes-all-tests/no-production-code-constants-in-tests.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../passes-all-tests/test-for-production.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../passes-all-tests/no-production-code-constants-in-tests.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../passes-all-tests/test-for-production.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
